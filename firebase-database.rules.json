{
  "rules": {
    "teams": {
      "$teamCode": {
        ".validate": "$teamCode.matches(/^[0-9]{6}$/)",

        "meta": {
          ".read": "auth != null",
          ".write": "auth != null && (!data.exists() || data.child('createdBy').val() === auth.uid)",

          "createdAtMs": { ".validate": "newData.isNumber()" },
          "createdBy": { ".validate": "newData.isString() && newData.val() === auth.uid" },
          "isLocked": { ".validate": "newData.isBoolean()" },
          "expiresAtMs": { ".validate": "newData.isNumber()" },
          "joinSalt": { ".validate": "newData.isString() && newData.val().matches(/^[0-9a-fA-F]{16,}$/)" },
          "joinHash": { ".validate": "newData.isString() && newData.val().matches(/^[0-9a-fA-F]{64}$/)" }
        },

        "members": {
          ".read": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists()",
          "$uid": {
            ".write": "auth != null && auth.uid === $uid && (data.exists() || (!root.child('teams').child($teamCode).child('meta').child('isLocked').exists() || root.child('teams').child($teamCode).child('meta').child('isLocked').val() === false)) && (!root.child('teams').child($teamCode).child('meta').child('expiresAtMs').exists() || now <= root.child('teams').child($teamCode).child('meta').child('expiresAtMs').val())",
            "callsign": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 24" },
            "joinedAtMs": { ".validate": "newData.isNumber()" },
            "$other": { ".validate": false }
          }
        },

        "state": {
          ".read": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists()",
          "$uid": {
            ".write": "auth != null && auth.uid === $uid && root.child('teams').child($teamCode).child('members').child($uid).exists()",
            "callsign": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 24" },
            "lat": { ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90" },
            "lon": { ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180" },
            "acc": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 10000" },
            "speed": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 150" },
            "heading": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() < 360" },
            "ts": { ".validate": "newData.isNumber()" },
            "mode": { ".validate": "newData.isString() && (newData.val() === 'GAME' || newData.val() === 'STEALTH' || newData.val() === 'DEAD')" },
            "anchored": { ".validate": "newData.isBoolean()" },
            "sosUntilMs": { ".validate": "newData.isNumber() && newData.val() >= 0" },
            "$other": { ".validate": false }
          }
        },

        "points": {
          ".read": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists()",
          "$pointId": {
            ".write": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists() && (!newData.exists() || (!data.exists() && newData.child('createdBy').val() === auth.uid) || (data.exists() && data.child('createdBy').val() === auth.uid))",
            "lat": { ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90" },
            "lon": { ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180" },
            "label": { ".validate": "newData.isString() && newData.val().length <= 64" },
            "icon": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 32" },
            "createdAtMs": { ".validate": "!data.exists() ? newData.isNumber() : newData.val() === data.val()" },
            "createdBy": { ".validate": "!data.exists() ? (newData.isString() && newData.val() === auth.uid) : newData.val() === data.val()" },
            "$other": { ".validate": false }
          }
        },

        "privatePoints": {
          "$uid": {
            ".read": "auth != null && auth.uid === $uid",
            "$pointId": {
              ".write": "auth != null && auth.uid === $uid",
              "lat": { ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90" },
              "lon": { ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180" },
              "label": { ".validate": "newData.isString() && newData.val().length <= 64" },
              "icon": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 32" },
              "createdAtMs": { ".validate": "!data.exists() ? newData.isNumber() : newData.val() === data.val()" },
              "createdBy": { ".validate": "!data.exists() ? (newData.isString() && newData.val() === auth.uid) : newData.val() === data.val()" },
              "$other": { ".validate": false }
            }
          }
        },

        "enemyPings": {
          ".read": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists()",
          "$pingId": {
            ".write": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists() && (!newData.exists() || newData.child('createdBy').val() === auth.uid)",
            "lat": { ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90" },
            "lon": { ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180" },
            "createdAtMs": { ".validate": "newData.isNumber()" },
            "createdBy": { ".validate": "newData.isString() && newData.val() === auth.uid" },
            "$other": { ".validate": false }
          }
        },

        "commands": {
          ".read": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists()",
          "$commandId": {
            ".write": "auth != null && root.child('teams').child($teamCode).child('members').child(auth.uid).exists() && (!newData.exists() || newData.child('createdBy').val() === auth.uid)",
            "type": { ".validate": "newData.isString() && (newData.val() === 'RALLY' || newData.val() === 'RETREAT' || newData.val() === 'ATTACK')" },
            "createdAtMs": { ".validate": "newData.isNumber()" },
            "createdBy": { ".validate": "newData.isString() && newData.val() === auth.uid" },
            "$other": { ".validate": false }
          }
        }
      }
    }
  }
}
