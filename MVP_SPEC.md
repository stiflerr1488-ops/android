# MVP спецификация: Командный компас (Android + Firebase RTDB)

## 1. Область MVP

### Что входит
- Создание матча и вход в матч по коду/QR.
- Список до 10 игроков-участников матча (свой ник + статусы участников).
- Экран «Компас»: стрелки на участников, расстояние, `last seen`, индикатор точности.
- Управление трекингом: кнопки «Старт игры» / «Стоп».
- Работа при перебоях связи: при отсутствии сети отображается последняя точка + метка времени.

### Что не входит
- Карты.
- Треки/история перемещений.
- Офлайн-обмен координатами без интернета (радиоканал не реализуется).

## 2. Правила матча
- Видимые игроки: только участники текущего матча (своя команда).
- Права в MVP: одинаковые у всех.
- Исключение: создатель матча может завершить матч вручную и закрыть матч для новых входов.
- Завершение матча:
  - вручную: кнопка «Завершить матч» (только у создателя),
  - автоматически: по `expiresAt` (TTL).
- Онлайн-статус игрока: точка обновлена не старше 20 секунд.

## 3. Вход и идентификация
- Авторизация: Firebase Anonymous Auth.
- Вход в матч: по `matchId` + `joinCode` (код/QR).
- `joinCode` хранится в БД в виде хеша (`SHA-256 + salt`).
- Локально хранить 1–5 последних `matchId` для быстрого повторного входа.
- Ник хранится локально, можно менять при входе.
- При коллизии ников: автоматический суффикс (`#2`, `#3`, ...).

## 4. Backend: Firebase Realtime Database

### Структура данных
```text
/matches/{matchId}/meta
  createdAt, expiresAt, createdBy, isLocked

/matches/{matchId}/members/{uid}
  nick, team, joinedAt

/matches/{matchId}/state/{uid}
  lat, lon, acc, speed, heading, ts
```

### Базовые security rules
- Читать `/state` и `/members` могут только участники матча.
- Писать `/state/{uid}` может только владелец `uid`.
- После истечения `expiresAt` матч считается недействительным.
- После `isLocked=true` новые участники не могут входить, текущие продолжают работу.

### TTL
- `expiresAt` по умолчанию: 12 часов.

## 5. Android архитектура

```text
data/
  firebase/   // подписки/запись RTDB
  local/      // Room (очередь/буфер)

domain/
  use-cases/  // StartMatch, JoinMatch, StartTracking, StopTracking

tracking/
  LocationProvider
  HeadingProvider
  TrackingService (Foreground Service, type=location)

ui/
  MatchScreen
  TeamListScreen
  CompassScreen
```

## 6. Трекинг и геолокация
- Провайдер: Fused Location Provider (`requestLocationUpdates`).
- Трекинг работает в foreground service, включая погашенный экран.
- При отзыве permission во время матча: авто-стоп + явный алерт.

### Режимы отправки
- «Игра» (дефолт): каждые 3 сек **или** при смещении > 10 м.
- «Тихо»: каждые 10 сек **или** при смещении > 30 м.

### Android SDK
- `minSdk = 26`.
- `targetSdk = 34`.

## 7. Heading и качество компаса
- Если скорость > 1–2 м/с: использовать курс по GPS.
- Если скорость ниже: использовать orientation по rotation vector + сглаживание.
- Устройства без магнитометра: fallback только по GPS-курсу.
- Подсказка в UI при fallback: «Для направления начни движение».
- В MVP показать простой индикатор «компас неточен».

## 8. Математика и правила отображения
Для каждого участника:
- `distance` по haversine.
- `bearing` до цели.
- `relative = normalize(bearing - myHeading)` в диапазоне `[-180..180]`.
- Стрелка поворачивается на `relative`.

### Staleness-состояния
- 0–20 сек: норм.
- 20–60 сек: сомнительно (приглушить).
- 60–120 сек: устарело (сильно приглушить + маркер «старые данные»).
- >120 сек: стрелку скрыть, игрок остаётся в списке со статусом «нет связи/нет данных».

### Точность
- Если `acc > 50 м`: показать иконку + текст «низкая точность», стрелку приглушить.

## 9. Сеть и офлайн
- При отсутствии сети UI живёт на `last seen`.
- Локальный буфер: максимум 200 записей (допустим ring-buffer).
- После восстановления сети отправлять только последний актуальный апдейт.
- Ретраи отправки: экспоненциальный backoff `1s -> 2s -> 4s -> ... -> 60s`.
- При деградации соединения показывать статус «проблемы связи».

## 10. Экраны MVP
1. Лобби матча:
   - создать матч,
   - показать/поделиться кодом и QR,
   - список участников и их статус.
2. Компас:
   - стрелки с никами,
   - `distance`, `last seen`, точность,
   - кнопки: «Центр», «Тихо», «Стоп».
3. Список:
   - сортировка по расстоянию и давности,
   - поиск по нику.

## 11. Логи и наблюдаемость (минимум для MVP)
- События трекинга: старт/стоп + причина.
- Ошибки геолокации (нет GPS/permission).
- Телеметрия отправки: время последней успешной отправки, число ошибок, текущий backoff.
- Staleness по каждому игроку (для диагностики «почему пропал»).

## 12. Критерии готовности MVP (Definition of Done)
- 10 устройств одновременно.
- Сессия 60 минут.
- Нет критических крашей.
- При стабильной связи задержка обновлений обычно < 10 сек.
- При потере связи стрелки корректно переходят в staleness-состояния.
- Интерфейс только на русском языке.
- Приоритет функциональности над визуальной полировкой.
